<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>红蓝对抗：高校网络安全攻防战</title>
    <style>
        body {
            margin: 0;
            font-family: '微软雅黑', Arial, sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .container {
            width: 1200px;
            max-width: 1200px;
            min-width: 1200px;
            aspect-ratio: 16/9;
            margin: 0 auto;
            background: url('./pic1.jpg') no-repeat center top;
            background-size: 100% auto;
            border-radius: 16px;
            box-shadow: 0 4px 32px #0002;
            padding: 48px 32px;
            position: relative;
            display: flex;
            flex-direction: column;
            color: #fff;
        }
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .title, .desc, .round, .system-value, .history, .result, .review, .role-status, .role-name, .center-status {
            color: #fff !important;
        }
        .role-btn.selected, .role-btn:hover {
            border-color: #ff8533;
            background: #ffe0cc;
            color: #cc4400;
        }
        .role-btn.selected.hacker {
            background: #fff0e6;
            border-color: #ffb366;
            color: #cc5500;
        }
        .role-btn.selected.defender {
            background: #e6f0ff;
            border-color: #99ccff;
            color: #0066cc;
        }
        .role-btn:not(.selected) {
            background: rgba(227,232,240,0.7);
            border-color: #bfc8d8;
            color: #444;
        }
        .role-btn.selected:not(.hacker):not(.defender) {
            background: #ffe0cc;
            border-color: #ff8533;
            color: #cc4400;
        }
        /* 黑客选项高亮 */
        .action-btn.hover-sim {
            background: #ffe0cc !important;
            border-color: #ff8533 !important;
            color: #cc4400 !important;
        }
        .title {
            text-align: center;
            font-size: 2.6em;
            font-weight: bold;
            margin-bottom: 24px;
        }
        .desc {
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.2em;
        }
        .role-select {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-bottom: 40px;
        }
        .role-btn {
            background: rgba(227,232,240,0.7);
            border: 3px solid #bfc8d8;
            border-radius: 16px;
            padding: 36px 70px;
            font-size: 1.7em;
            cursor: pointer;
            transition: 0.2s;
            color: #444;
        }
        .start-btn {
            display: block;
            margin: 0 auto;
            background: linear-gradient(90deg, #1976d2, #e53935);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 20px 70px;
            font-size: 1.3em;
            cursor: pointer;
            transition: 0.2s;
        }
        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .game-main {
            display: flex;
            height: 100%;
            flex: 1;
            min-height: 0;
        }
        .side {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            height: 100%;
        }
        .side.left {
            align-items: flex-start;
        }
        .side.right {
            align-items: flex-end;
        }
        .side .role-status {
            font-size: 1.2em;
            color: #1976d2;
            margin-bottom: 18px;
            margin-top: 0;
        }
        .side .row-flex {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 32px;
        }
        .side.left .row-flex {
            justify-content: flex-start;
        }
        .side.right .row-flex {
            justify-content: flex-end;
        }
        .side .actions {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 0;
            margin-top: 0;
        }
        .side .action-btn, .side .action-placeholder {
            width: 180px;
            padding: 16px 0;
            border-radius: 10px;
            border: 2px solid #bfc8d8;
            background: #f5f7fa;
            font-size: 1.2em;
            cursor: pointer;
            transition: 0.2s;
        }
        .side .action-btn:disabled {
            background: #eee;
            color: #aaa;
            cursor: not-allowed;
        }
        .side .action-placeholder {
            color: #bbb;
            background: #f0f0f0;
            border-style: dashed;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .side .action-placeholder::before {
            content: "?";
            font-size: 1.8em;
        }
        .side .action-placeholder.waiting::before {
            content: "等待";
            font-size: 1.2em;
        }
        .side .role-img {
            width: 140px;
            height: 248px;
            background: transparent !important;
            border: 3px solid #bbb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bbb;
            font-size: 2.5em;
            padding: 0;
            overflow: hidden;
        }
        .side .role-name {
            font-weight: bold;
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        .side.left .role-name {
            align-self: flex-start;
        }
        .side.right .role-name {
            align-self: flex-end;
        }
        .center {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin-left: -20px;
        }
        .center .center-status {
            font-size: 1.2em;
            color: #1976d2;
            margin-bottom: 18px;
            margin-top: 0;
        }
        .round {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 18px;
        }
        .system-status {
            width: 350px;
            height: 32px;
            background: #eee;
            border-radius: 16px;
            margin-bottom: 18px;
            overflow: hidden;
            position: relative;
        }
        .system-bar {
            height: 100%;
            background: linear-gradient(90deg, #e53935, #1976d2);
            transition: width 0.4s;
        }
        .system-value {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%);
            font-size: 1.2em;
            color: #222;
            font-weight: bold;
        }
        .history {
            width: 100%;
            background: #f8fafc;
            border-radius: 12px;
            padding: 18px 24px;
            height: 200px;
            overflow-y: auto;
            font-size: 1.1em;
            color: #444;
            box-sizing: border-box;
        }
        .history::-webkit-scrollbar {
            width: 8px;
        }
        .history::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .history::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .history::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .result {
            text-align: center;
            font-size: 2em;
            color: #1976d2;
            margin-top: 40px;
        }
        .review {
            margin: 0 auto;
            margin-top: 24px;
            max-width: 800px;
            background: #f4f6fa;
            border-radius: 12px;
            padding: 24px;
            font-size: 1.1em;
            color: #333;
        }
        .back-btn {
            position: relative;
            margin-top: 20px;
            background: #fff;
            border: 2px solid #1976d2;
            color: #1976d2;
            border-radius: 8px;
            padding: 10px 28px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px #0001;
            transition: background 0.2s, color 0.2s;
        }
        .back-btn:hover {
            background: #1976d2;
            color: #fff;
        }
        /* 选项颜色 */
        .side.left .action-btn, .side.left .action-placeholder {
            background: #fff0e6;
            border-color: #ffb366;
            color: #cc5500;
        }
        .side.left .action-btn:hover,
        .side.left .action-btn.selected {
            background: #ffe0cc;
            border-color: #ff8533;
            color: #cc4400;
        }
        .side.right .action-btn, .side.right .action-placeholder {
            background: #e6f0ff;
            border-color: #99ccff;
            color: #0066cc;
        }
        .side.right .action-btn:hover,
        .side.right .action-btn.selected {
            background: #cce6ff;
            border-color: #66b3ff;
            color: #004d99;
        }
        /* 高校模式左蓝右橙红 */
        .defender-mode .side.left .action-btn, .defender-mode .side.left .action-placeholder {
            background: #e6f0ff;
            border-color: #99ccff;
            color: #0066cc;
        }
        .defender-mode .side.left .action-btn:hover,
        .defender-mode .side.left .action-btn.selected {
            background: #cce6ff;
            border-color: #66b3ff;
            color: #004d99;
        }
        .defender-mode .side.right .action-btn, .defender-mode .side.right .action-placeholder {
            background: #fff0e6;
            border-color: #ffb366;
            color: #cc5500;
        }
        .defender-mode .side.right .action-btn:hover,
        .defender-mode .side.right .action-btn.selected {
            background: #ffe0cc;
            border-color: #ff8533;
            color: #cc4400;
        }
        /* 图片框实线边框 */
        .side .role-img {
            border-style: solid;
        }
        .side.left .role-img {
            border-color: #ffb366;
        }
        .side.right .role-img {
            border-color: #99ccff;
        }
        .defender-mode .side.left .role-img {
            border-color: #99ccff;
        }
        .defender-mode .side.right .role-img {
            border-color: #ffb366;
        }
        /* 按钮与底部按钮样式 */
        .start-btn, .back-btn {
            background: rgba(227,232,240,0.7);
            color: #444;
            border: 2px solid #bfc8d8;
            transition: background 0.2s, color 0.2s;
        }
        .start-btn.selected, .start-btn:hover, .back-btn.selected, .back-btn:hover {
            background: linear-gradient(90deg, #1976d2, #e53935) !important;
            color: #fff !important;
            border: none;
        }
        /* 历史/复盘框浅灰半透明 */
        .history, .review {
            color: #333 !important;
            background: rgba(244,246,250,0.85) !important;
        }
        /* 大号白字黑描边 */
        .title, .round, .result {
            color: #fff !important;
            text-shadow: 0 0 2px #000, 0 0 2px #000, 0 1px 2px #000, 1px 0 2px #000;
        }
        /* 用户未操作方选项框边缘为实线 */
        .side .action-btn, .side .action-placeholder {
            border-style: solid;
        }
        /* 图片框填充透明，边框不变 */
        .side .role-img {
            background: transparent !important;
        }
        /* 图片框图片和动态填充 */
        .role-img-inner {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .role-img-pic {
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .role-img-fill {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 8px;
            z-index: 1;
        }
        .role-img-fill.red {
            background: rgba(229,57,53,0.35);
        }
        .role-img-fill.blue {
            background: rgba(25,118,210,0.35);
        }
        .role-img-fill.none {
            background: transparent;
        }
        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background-image: url('./pic1');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-board {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            margin: 20px auto;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            padding: 10px;
        }

        .game-info {
            position: relative;
            width: 100%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div id="start-screen">
            <div class="title">红蓝对抗：高校网络安全攻防战</div>
            <div class="desc">请选择你的角色，体验真实的网络攻防对抗！</div>
            <div class="role-select">
                <div class="role-btn" id="hacker-btn">黑客</div>
                <div class="role-btn" id="defender-btn">高校</div>
            </div>
            <button class="start-btn" id="start-btn" disabled>开始模拟</button>
        </div>
    </div>
    <script>
        const attackDefs = [
            { name: "超频攻击", value: 23, defenses: ["关机冷却", "检查BIOS"] },
            { name: "内存溢出攻击", value: 20, defenses: ["重启", "更新修复"] },
            { name: "提权漏洞攻击", value: 26, defenses: ["安全模式", "重装更新"] },
            { name: "服务劫持", value: 15, defenses: ["禁服务", "杀毒恢复"] },
            { name: "勒索软件加密", value: 30, defenses: ["断网", "备份恢复"] },
            { name: "固件木马", value: 29, defenses: ["刷新固件", "联系厂商"] },
            { name: "ARP欺骗", value: 14, defenses: ["防火墙", "ARP防护"] },
            { name: "DNS劫持", value: 12, defenses: ["重置路由", "改DNS"] },
            { name: "间谍软件监控", value: 9, defenses: ["禁设备", "查进程"] },
            { name: "恶意脚本注入", value: 11, defenses: ["清缓存", "重置浏览器"] },
            { name: "恶意软件捆绑", value: 17, defenses: ["卸载", "全盘扫描"] },
            { name: "钓鱼攻击", value: 8, defenses: ["改密码", "启用2FA"] },
            { name: "数据窃取木马", value: 21, defenses: ["断网", "扫描监控"] }
        ];
        function getAllDefenses() {
            let allDefenses = new Set();
            attackDefs.forEach(attack => {
                attack.defenses.forEach(defense => {
                    allDefenses.add(defense);
                });
            });
            return Array.from(allDefenses);
        }
        function getInvalidDefenses(currentAttack) {
            let allDefenses = getAllDefenses();
            return allDefenses.filter(defense => !currentAttack.defenses.includes(defense));
        }
        function generateDefenseOptions(attack) {
            if (!role) return [];
            let options = [];
            let invalidDefenses = getInvalidDefenses(attack);
            if (role === 'defender') {
                let validDefense = attack.defenses[Math.floor(Math.random() * attack.defenses.length)];
                options.push(validDefense);
            } else {
                if (Math.random() < 0.7) {
                    let validDefense = attack.defenses[Math.floor(Math.random() * attack.defenses.length)];
                    options.push(validDefense);
                }
            }
            let numInvalid = options.length === 0 ? 3 : 2;
            for(let i = 0; i < numInvalid && invalidDefenses.length > 0; i++) {
                let randomIndex = Math.floor(Math.random() * invalidDefenses.length);
                options.push(invalidDefenses[randomIndex]);
                invalidDefenses.splice(randomIndex, 1);
            }
            return options.sort(() => Math.random() - 0.5);
        }
        function calculateDamage(attackValue, isEffective) {
            if (isEffective) return 0;
            return Math.random() < 0.5 ? attackValue : Math.floor(attackValue * 2/3);
        }
        let hackerActions = attackDefs.map(a => a.name);
        let defenderActions = getAllDefenses();
        let role = null;
        let round = 1;
        let maxRound = 10;
        let systemStatus = 100;
        let history = [];
        let gameOver = false;
        let waitingForDefend = false;
        let currentAttack = null;
        let currentDefenseOptions = null;
        let currentHackerActs = null;
        function bindStartEvents() {
            const hackerBtn = document.getElementById('hacker-btn');
            const defenderBtn = document.getElementById('defender-btn');
            const startBtn = document.getElementById('start-btn');
            hackerBtn.onclick = () => {
                role = 'hacker';
                hackerBtn.classList.add('selected','hacker');
                defenderBtn.classList.remove('selected','defender');
                startBtn.disabled = false;
            };
            defenderBtn.onclick = () => {
                role = 'defender';
                defenderBtn.classList.add('selected','defender');
                hackerBtn.classList.remove('selected','hacker');
                startBtn.disabled = false;
            };
            startBtn.onclick = () => {
                document.getElementById('start-screen').style.display = 'none';
                renderGame();
            };
        }
        bindStartEvents();
        function renderGame() {
            if (role === 'hacker') {
                renderHackerGame();
            } else {
                renderDefenderGame();
            }
        }
        function renderHackerGame() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            document.body.classList.remove('defender-mode');
            currentHackerActs = getRandomActions(hackerActions);
            let left = renderSide('hacker', true);
            let right = renderSide('defender', false);
            let center = renderCenter();
            const main = document.createElement('div');
            main.className = 'game-main';
            left.classList.add('left');
            right.classList.add('right');
            main.appendChild(left);
            main.appendChild(center);
            main.appendChild(right);
            app.appendChild(main);
            if (!gameOver) simulateAIDefense(right);
            // 添加返回按钮到底部
            const backBtn = document.createElement('button');
            backBtn.className = 'back-btn';
            backBtn.innerText = '返回初始页面';
            backBtn.onclick = backToStart;
            center.appendChild(backBtn);
        }
        function renderDefenderGame() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            document.body.classList.add('defender-mode');
            if (!waitingForDefend) {
                const aiActIdx = Math.floor(Math.random()*attackDefs.length);
                const aiAct = attackDefs[aiActIdx];
                currentAttack = aiAct;
                currentDefenseOptions = generateDefenseOptions(aiAct);
                waitingForDefend = true;
            }
            let left = renderSide('defender', true, true);
            let right = renderSide('hacker', false, true);
            let center = renderCenter();
            const main = document.createElement('div');
            main.className = 'game-main';
            left.classList.add('left');
            right.classList.add('right');
            main.appendChild(left);
            main.appendChild(center);
            main.appendChild(right);
            app.appendChild(main);
            if (!gameOver) simulateAIAttack(right);
            // 添加返回按钮到底部
            const backBtn = document.createElement('button');
            backBtn.className = 'back-btn';
            backBtn.innerText = '返回初始页面';
            backBtn.onclick = backToStart;
            center.appendChild(backBtn);
        }
        function renderSide(side, isPlayer, defenderMode) {
            const div = document.createElement('div');
            div.className = 'side';
            // 顶端状态字样
            const status = document.createElement('div');
            status.className = 'role-status';
            status.id = side + '-status';
            let statusText = '等待中';
            let isAction = false;
            if (role === 'hacker') {
                if (side === 'hacker') {
                    isAction = isPlayer && !gameOver;
                    statusText = isAction ? '攻击中' : '等待中';
                } else {
                    isAction = !isPlayer && !gameOver;
                    statusText = isPlayer && !gameOver ? '等待中' : '防守中';
                }
            } else {
                if (side === 'defender') {
                    isAction = isPlayer && !gameOver;
                    statusText = isAction ? '防守中' : '等待中';
                } else {
                    isAction = !isPlayer && !gameOver;
                    statusText = isPlayer && !gameOver ? '等待中' : '攻击中';
                }
            }
            status.innerText = statusText;
            div.appendChild(status);
            const name = document.createElement('div');
            name.className = 'role-name';
            name.innerText = side === 'hacker' ? '黑客' : '高校';
            div.appendChild(name);
            // 横向排列选项框和图片框，左侧与右侧对称
            const row = document.createElement('div');
            row.className = 'row-flex';
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'actions';
            if (isPlayer && !gameOver) {
                let acts;
                if (role === 'hacker' && side === 'hacker') {
                    acts = currentHackerActs || getRandomActions(hackerActions);
                } else if (role === 'defender' && side === 'defender' && waitingForDefend) {
                    acts = currentDefenseOptions || [];
                } else {
                    acts = [];
                }
                acts.forEach((act, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.innerText = act;
                    btn.onclick = () => handleAction(idx);
                    btn.disabled = false;
                    actionsDiv.appendChild(btn);
                });
                if (acts.length === 0) {
                    for (let i = 0; i < 2; i++) {
                        const ph = document.createElement('div');
                        ph.className = 'action-placeholder waiting';
                        actionsDiv.appendChild(ph);
                    }
                }
            } else {
                for (let i = 0; i < 2; i++) {
                    const ph = document.createElement('div');
                    ph.className = 'action-placeholder';
                    actionsDiv.appendChild(ph);
                }
            }
            // 图片框
            const img = document.createElement('div');
            img.className = 'role-img';
            // 填充图片和动态色
            const imgInner = document.createElement('div');
            imgInner.className = 'role-img-inner';
            const imgPic = document.createElement('img');
            imgPic.className = 'role-img-pic';
            let imgFill = document.createElement('div');
            imgFill.className = 'role-img-fill none';
            // 选择图片和翻转
            if (role === 'hacker' && !defenderMode) {
                if (side === 'hacker') {
                    imgPic.src = './攻击方.png';
                    imgPic.style.transform = '';
                } else {
                    imgPic.src = './防守方.png';
                    imgPic.style.transform = '';
                }
            } else if (role === 'defender' && defenderMode) {
                if (side === 'defender') {
                    imgPic.src = './防守方.png';
                    imgPic.style.objectFit = 'contain';
                    imgPic.style.width = '100%';
                    imgPic.style.height = '100%';
                    imgPic.style.left = '50%';
                    imgPic.style.top = '50%';
                    imgPic.style.transform = 'translate(-50%,-50%) scaleX(-1)';
                } else {
                    imgPic.src = './攻击方.png';
                    imgPic.style.objectFit = 'contain';
                    imgPic.style.width = '100%';
                    imgPic.style.height = '100%';
                    imgPic.style.left = '50%';
                    imgPic.style.top = '50%';
                    imgPic.style.transform = 'translate(-50%,-50%) scaleX(-1)';
                }
            }
            imgInner.appendChild(imgFill);
            imgInner.appendChild(imgPic);
            img.appendChild(imgInner);
            // 根据模式和左右，灵活调整图片框和选项框顺序
            if (role === 'hacker' && !defenderMode) {
                // 黑客模式：左（攻击方）图片-选项，右（防守方）选项-图片
                if (side === 'hacker') {
                    row.appendChild(img);
                    row.appendChild(actionsDiv);
                } else if (side === 'defender') {
                    row.appendChild(actionsDiv);
                    row.appendChild(img);
                }
            } else if (role === 'defender' && defenderMode) {
                // 高校模式：左（防守方）图片-选项，右（攻击方）选项-图片
                if (side === 'defender') {
                    row.appendChild(img);
                    row.appendChild(actionsDiv);
                } else if (side === 'hacker') {
                    row.appendChild(actionsDiv);
                    row.appendChild(img);
                }
            }
            div.appendChild(row);
            return div;
        }
        function renderCenter() {
            const div = document.createElement('div');
            div.className = 'center';
            const roundDiv = document.createElement('div');
            roundDiv.className = 'round';
            roundDiv.innerText = `第${round}回合`;
            div.appendChild(roundDiv);
            const sysDiv = document.createElement('div');
            sysDiv.className = 'system-status';
            const bar = document.createElement('div');
            bar.className = 'system-bar';
            bar.style.width = systemStatus + '%';
            sysDiv.appendChild(bar);
            const value = document.createElement('div');
            value.className = 'system-value';
            value.innerText = `${systemStatus} / 100`;
            sysDiv.appendChild(value);
            div.appendChild(sysDiv);
            const hisDiv = document.createElement('div');
            hisDiv.className = 'history';
            hisDiv.innerHTML = history.map((h, i) => `第${i+1}回合：${h}`).join('<br>') || '暂无操作';
            div.appendChild(hisDiv);
            setTimeout(() => {
                hisDiv.scrollTop = hisDiv.scrollHeight;
            }, 0);
            return div;
        }
        function handleAction(idx) {
            if (gameOver) return;
            if (role === 'defender' && waitingForDefend) {
                document.getElementById('defender-status').innerText = '防御中';
                setTimeout(() => {
                    let playerAct = currentDefenseOptions[idx];
                    let isEffective = currentAttack.defenses.includes(playerAct);
                    let damage = calculateDamage(currentAttack.value, isEffective);
                    systemStatus = Math.max(0, systemStatus - damage);
                    history.push(`黑客发起"${currentAttack.name}"，你选择了"${playerAct}"，${isEffective ? '成功防御！' : `系统状态下降${damage}点`}`);
                    currentAttack = null;
                    currentDefenseOptions = null;
                    waitingForDefend = false;
                    if (systemStatus <= 0) {
                        gameOver = true;
                        setTimeout(renderResult, 600);
                    } else if (round >= maxRound) {
                        gameOver = true;
                        setTimeout(renderResult, 600);
                    } else {
                        round++;
                        renderGame();
                    }
                }, 700);
                return;
            }
            if (role === 'hacker') {
                document.getElementById('hacker-status').innerText = '攻击中';
                setTimeout(() => {
                    let playerAct = currentHackerActs[idx];
                    let attack = attackDefs.find(a => a.name === playerAct);
                    currentAttack = attack;
                    currentDefenseOptions = generateDefenseOptions(attack);
                    let aiDefense = currentDefenseOptions[Math.floor(Math.random() * currentDefenseOptions.length)];
                    let isEffective = attack.defenses.includes(aiDefense);
                    let damage = calculateDamage(attack.value, isEffective);
                    systemStatus = Math.max(0, systemStatus - damage);
                    history.push(`你选择了"${playerAct}"，防守方选择了"${aiDefense}"，${isEffective ? '防守成功！' : `系统状态下降${damage}点`}`);
                    currentHackerActs = null;
                    if (systemStatus <= 0) {
                        gameOver = true;
                        setTimeout(renderResult, 600);
                    } else if (round >= maxRound) {
                        gameOver = true;
                        setTimeout(renderResult, 600);
                    } else {
                        round++;
                        renderGame();
                    }
                }, 700);
            }
        }
        function renderResult() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            let win = false;
            if (role === 'hacker') {
                win = systemStatus <= 0;
            } else {
                win = systemStatus > 0;
            }
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerText = win ? (role==='hacker' ? '恭喜你胜利了！' : '恭喜你防守成功！') : (role==='hacker' ? '很遗憾，防守方胜利！' : '很遗憾，系统被攻破！');
            app.appendChild(resultDiv);

            // 根据角色设置游戏结束界面图片
            const resultImage = document.createElement('img');
            resultImage.style.width = '200px';
            resultImage.style.height = '200px';
            resultImage.style.margin = '20px auto';
            resultImage.style.display = 'block';
            resultImage.style.borderRadius = '50%';
            resultImage.style.objectFit = 'cover';
            if (role === 'hacker') {
                resultImage.src = './攻击方.png';
            } else {
                resultImage.src = './防守方.png';
            }
            app.appendChild(resultImage);

            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review';
            // 复盘内容，失败时补充有效防守说明
            reviewDiv.innerHTML = '<b>操作复盘：</b><br>' + history.map((h, i) => {
                if (/你选择了|你选择了/.test(h) && /系统状态下降|系统状态下降/.test(h)) {
                    // 查找有效防守
                    let attackName = h.match(/"([^"]+)"/);
                    let attack = attackName ? attackName[1] : null;
                    let valid = '';
                    if (attack) {
                        let def = attackDefs.find(a => a.name === attack);
                        if (def) {
                            valid = `<span style="color:#1976d2">有效防守操作：${def.defenses.join('、')}</span>`;
                        }
                    }
                    return `第${i+1}回合：${h}<br>${valid}`;
                } else {
                    return `第${i+1}回合：${h}`;
                }
            }).join('<br>');
            app.appendChild(reviewDiv);
            // 添加返回按钮到底部
            const backBtn = document.createElement('button');
            backBtn.className = 'back-btn';
            backBtn.innerText = '返回初始页面';
            backBtn.onclick = backToStart;
            backBtn.style.marginTop = '40px';
            app.appendChild(backBtn);
        }
        function backToStart() {
            role = null;
            round = 1;
            systemStatus = 100;
            history = [];
            gameOver = false;
            waitingForDefend = false;
            currentAttack = null;
            currentDefenseOptions = null;
            currentHackerActs = null;
            document.getElementById('app').innerHTML = `
                <div id="start-screen">
                    <div class="title">红蓝对抗：高校网络安全攻防战</div>
                    <div class="desc">请选择你的角色，体验真实的网络攻防对抗！</div>
                    <div class="role-select">
                        <div class="role-btn" id="hacker-btn">黑客</div>
                        <div class="role-btn" id="defender-btn">高校</div>
                    </div>
                    <button class="start-btn" id="start-btn" disabled>开始模拟</button>
                </div>
            `;
            bindStartEvents();
        }
        function getRandomActions(arr, nMin=2, nMax=3) {
            let n = Math.floor(Math.random() * (nMax-nMin+1)) + nMin;
            let arrCopy = arr.slice();
            let res = [];
            for(let i=0;i<n && arrCopy.length>0;i++){
                let idx = Math.floor(Math.random()*arrCopy.length);
                res.push(arrCopy[idx]);
                arrCopy.splice(idx,1);
            }
            return res;
        }
        // AI动画相关
        function simulateAIDefense(rightDiv) {
            const status = rightDiv.querySelector('.role-status');
            status.innerText = '思考中';
            const btns = rightDiv.querySelectorAll('.action-btn');
            let wait = 1000 + Math.random()*2000;
            let phaseArr = [0.5, 1/3, 1/5, 2/3];
            let phase = phaseArr[Math.floor(Math.random()*4)];
            let phaseTime = wait * (1-phase);
            let hoverIdx = Math.floor(Math.random()*btns.length);
            setTimeout(()=>{
                btns[hoverIdx].classList.add('hover-sim');
            }, phaseTime);
            setTimeout(()=>{
                btns[hoverIdx].classList.remove('hover-sim');
                status.innerText = '等待中';
            }, wait);
        }
        function simulateAIAttack(rightDiv) {
            const status = rightDiv.querySelector('.role-status');
            status.innerText = '思考中';
            const btns = rightDiv.querySelectorAll('.action-btn');
            let wait = 1000 + Math.random()*2000;
            let phaseArr = [0.5, 1/3, 1/5, 2/3];
            let phase = phaseArr[Math.floor(Math.random()*4)];
            let phaseTime = wait * (1-phase);
            let hoverIdx = Math.floor(Math.random()*btns.length);
            setTimeout(()=>{
                btns[hoverIdx].classList.add('hover-sim');
            }, phaseTime);
            setTimeout(()=>{
                btns[hoverIdx].classList.remove('hover-sim');
                status.innerText = '等待中';
            }, wait);
        }
    </script>
</body>
</html> 